# Анализ логики работы Jarvis Bot

## Обзор

Jarvis Bot - это автоматический помощник, который собирает энергию вместо игрока и предотвращает перегрев электростанции. Данный документ описывает детальную логику работы Jarvis и его влияние на процент power электростанции.

## Основные компоненты

### 1. Условия активации Jarvis

Jarvis активен для пользователя, если выполняются следующие условия:
- `jarvis_expires > now` (время действия Jarvis не истекло)
- `jarvis_expires IS NOT NULL` (поле установлено)
- `building_until < now` ИЛИ `building_until IS NULL` (станция не находится в процессе строительства)

**Код:** `edit/boosters.py:68-72`

```python
for u in UserProfile.objects.filter(
    Q(jarvis_expires__gt=now)
    & Q(jarvis_expires__isnull=False)
    & (Q(building_until__lt=now) | Q(building_until__isnull=True))
).all():
```

### 2. Генерация энергии с Jarvis

#### Формула расчета энергии

Энергия добавляется каждые 2 секунды (цикл в `boosters.py`) по формуле:

```
added_kw = generation_rate * power / 100 / 1800 * jarvis_percent / 100 * sbt_get_jarvis()
```

**Компоненты формулы:**
- `generation_rate` - скорость генерации электростанции (kW/час)
- `power` - текущий процент power электростанции (0-100)
- `/ 100` - преобразование процента power в коэффициент (0.0-1.0)
- `/ 1800` - преобразование из часов в секунды (3600 сек / 2 = 1800, т.к. цикл каждые 2 сек)
- `jarvis_percent` - настройка из таблицы Booster (поле `n1`, по умолчанию 100%)
- `/ 100` - преобразование процента в коэффициент
- `sbt_get_jarvis()` - бонус от premium подписки:
  - Возвращает `1.05` если активна premium подписка
  - Возвращает `1.0` в остальных случаях

**Код:** `edit/boosters.py:73`

```python
added_kw = float(u.generation_rate) * float(u.power) / 100 / 1800 * jarvis_percent / 100 * u.sbt_get_jarvis()
```

#### Пример расчета

Для станции с параметрами:
- `generation_rate = 1000 kW/час`
- `power = 80%`
- `jarvis_percent = 100%` (по умолчанию)
- `sbt_get_jarvis() = 1.0` (без premium)

```
added_kw = 1000 * 80 / 100 / 1800 * 100 / 100 * 1.0
         = 1000 * 0.8 / 1800 * 1.0
         = 800 / 1800
         = 0.444 kW каждые 2 секунды
```

За час: `0.444 * 1800 = 800 kW` (что соответствует `generation_rate * power / 100 = 1000 * 0.8 = 800 kW`)

### 3. Влияние Jarvis на снижение power

#### Логика снижения power

**Важно:** Jarvis НЕ предотвращает снижение power полностью. Power продолжает снижаться, но с другой скоростью.

#### Формула снижения power с Jarvis

Каждые 2 секунды power снижается по формуле:

```
power = power - (1 / 3600 * sbt_get_power())
```

**Компоненты:**
- `1 / 3600` - снижение на 1 единицу за час (3600 секунд)
- `sbt_get_power()` - модификатор от SBT/premium:
  - `0.9` для Gold SBT или Premium подписки (снижение на 10% медленнее)
  - `0.95` для Silver SBT (снижение на 5% медленнее)
  - `1.0` для обычных пользователей

**Код:** `edit/boosters.py:94-95`

```python
# Обычное снижение power
update_data["power"] = F("power") - 1 / 3600 * u.sbt_get_power()
```

#### Сравнение с обычным тапом

**Обычный тап** (без Jarvis):
```
power = power - (tapped_kw / generation_rate / 2 * sbt_get_power())
```

**С Jarvis:**
```
power = power - (1 / 3600 * sbt_get_power())
```

**Ключевое отличие:**
- При обычном тапе power снижается пропорционально количеству собранной энергии
- С Jarvis power снижается равномерно по времени, независимо от генерации

#### Пример снижения power

Для пользователя без SBT/premium (`sbt_get_power() = 1.0`):

```
Снижение за 2 секунды = 1 / 3600 * 1.0 = 0.000278%
Снижение за час = 0.000278 * 1800 = 0.5%
Снижение за сутки = 0.5 * 24 = 12%
```

Для пользователя с Premium (`sbt_get_power() = 0.9`):

```
Снижение за 2 секунды = 1 / 3600 * 0.9 = 0.00025%
Снижение за час = 0.00025 * 1800 = 0.45%
Снижение за сутки = 0.45 * 24 = 10.8%
```

### 4. Взаимодействие с Repair Kit

Если активен Repair Kit (`repair_kit_expires > now`), то:
- Power **НЕ снижается** при работе Jarvis
- Power может быть поднят до уровня `repair_kit_power_level`, если он ниже

**Код:** `edit/boosters.py:85-92`

```python
if is_repair_kit_active and u.repair_kit_power_level is not None:
    # Repair Kit активен: power вообще не должен снижаться
    update_data["power"] = Greatest(
        F("power"),
        u.repair_kit_power_level,
    )
```

### 5. Влияние на расчет общей генерации сети

Jarvis влияет на расчет общей активной генерации сети (`get_total_active_generation()`).

**Логика:** Станции с активным Jarvis считаются активными **даже если storage заполнен**.

**Код:** `edit/core/views.py:4520-4527`

```python
total_generation = (
    UserProfile.objects.filter(
        Q(storage__lt=F("storage_limit"))  # Станция еще не заполнена
        | (
            Q(jarvis_expires__gt=now)  # ИЛИ Jarvis активен
            & Q(jarvis_expires__isnull=False)
            & (Q(building_until__lt=now) | Q(building_until__isnull=True))
        )
    ).aggregate(total=Sum(F("generation_rate") * F("power") / 100))
)["total"] or 0
```

**Формула генерации для каждой станции:**
```
generation = generation_rate * power / 100
```

Это означает, что станции с Jarvis продолжают генерировать энергию и учитываться в общей статистике сети, даже когда storage заполнен.

### 6. Цикл работы Jarvis

**Частота выполнения:** Каждые 2 секунды

**Процесс:**
1. Получение настройки `jarvis_percent` из таблицы Booster (slug="jarvis")
2. Поиск всех пользователей с активным Jarvis
3. Для каждого пользователя:
   - Расчет добавляемой энергии
   - Обновление поля `energy`
   - Обновление поля `power` (снижение или сохранение при Repair Kit)
   - Обновление `WalletInfo.kw_amount`
   - Добавление в статистику графиков
4. Очистка отрицательных значений power (установка в 0)

**Код:** `edit/boosters.py:60-105`

### 7. Защита от перегрева

**Важное свойство Jarvis:** При активном Jarvis игрок **не может** вручную тапать энергию, что предотвращает перегрев.

**Код:** `edit/core/views.py:281-285`

```python
if user_profile.jarvis_expires and user_profile.jarvis_expires > timezone.now():
    return Response(
        {"error": "Jarvis is active. Please wait until it expires."},
        status=status.HTTP_400_BAD_REQUEST,
    )
```

Это означает, что:
- Jarvis собирает энергию автоматически
- Игрок не может вызвать перегрев через ручной тап
- Power снижается только по формуле времени, а не от тапов

## Выводы

### Влияние Jarvis на процент power электростанции:

1. **Power продолжает снижаться** при работе Jarvis, но с фиксированной скоростью:
   - Без SBT/Premium: `-0.5% в час` или `-12% в сутки`
   - С Premium/Gold SBT: `-0.45% в час` или `-10.8% в сутки`
   - С Silver SBT: `-0.475% в час` или `-11.4% в сутки`

2. **Скорость снижения не зависит от генерации энергии** - power снижается равномерно по времени, независимо от того, сколько энергии генерируется.

3. **Jarvis не предотвращает снижение power**, но делает его предсказуемым и равномерным.

4. **Repair Kit полностью останавливает снижение power** при активном Jarvis.

5. **Станции с Jarvis считаются активными** в общей статистике сети даже при заполненном storage, что влияет на расчет `station_power` в графиках.

### Преимущества Jarvis:

- Автоматический сбор энергии без участия игрока
- Предотвращение перегрева (игрок не может тапать вручную)
- Равномерное снижение power (предсказуемо)
- Продолжение генерации даже при заполненном storage
- Бонус +5% генерации для Premium подписчиков

### Ограничения:

- Power все равно снижается со временем
- Требуется активация (покупка или NFT)
- Не работает во время строительства станции
