# Интеграция реферальных бонусов (kW) с энергозабегом

**Дата анализа:** 2025-02-27  
**Задача:** Раньше реф-бонус по kW начислялся при тапах; тапов нет, энергия собирается в забеге. Нужно при начислении энергии по результатам забега («Забрать») использовать ту же двухуровневую реферальную логику.

---

## 1. Текущая реферальная система (кратко)

- **Двухуровневая:** у пользователя может быть `referrer` (уровень 1) и `referrer_level_2` (уровень 2).
- **Поля в `UserProfile`:**
  - У реферера (кто пригласил): `bonus_kw_level_1`, `bonus_kw_level_2` — накопленные бонусы в kW.
  - У приглашённого (реферала): `bring_bonus_kw_level_1` — сколько принёс рефереру 1-го уровня; у реферера 1-го уровня: `bring_bonus_kw_level_2` — сколько его реферал принёс рефереру 2-го уровня.
- **Вывод бонусов:** пользователь нажимает «Забрать» на вкладке Friends → `POST get-kw-referral-bonuses/` → бонусы переводятся в основной баланс (kW), поля обнуляются (логика в бэкенде).

---

## 2. Где раньше начислялся реф-бонус по kW (тапы)

**Файл:** `edit/core/views.py` (и дубликат в `views.py`) — **TapEnergyView**.

При каждом тапе (`tap-energy/`):
- `tapped_kw` — объём энергии, полученной пользователем за тап.
- Рефереру 1-го уровня:
  - `bonus_kw_level_1 += tapped_kw * 0.1`
  - у **текущего пользователя** (реферала): `bring_bonus_kw_level_1 += tapped_kw * 0.1`
- Рефереру 2-го уровня:
  - `bonus_kw_level_2 += tapped_kw * 0.05`
  - у **реферера 1-го уровня**: `bring_bonus_kw_level_2 += tapped_kw * 0.05`

То есть: **10% от kW — рефереру 1-го уровня, 5% — рефереру 2-го уровня.**  
Тапов в продукте больше нет, этот путь не используется для сбора энергии.

---

## 3. Где сейчас начисляется энергия за забег

- **Сбор энергии:** в раннере, во время забега (`GameRunView.vue` + `useGameRun.js`): пользователь собирает поинты, накапливается `energyCollected`.
- **Завершение забега:** `POST game-run-complete/` — только валидация и расчёт, **энергию на баланс не начисляет**.
- **Начисление на баланс:** при нажатии «Забрать» вызывается `POST game-run-claim/` — **GameRunClaimView** в `edit/core/views.py` (примерно строки 2598–2807).

В **GameRunClaimView** сейчас:
- Считается `final_energy` (с учётом победы/проигрыша и сохранённого процента при проигрыше).
- Начисляется `final_energy` на баланс пользователя (`energy`, `WalletInfo.kw_amount`).
- Обновляется статистика, график, очищаются `energy_run_start_storage` и `energy_run_claimed_at`.
- **Реферальная логика отсутствует** — реферерам от энергии забега ничего не начисляется.

---

## 4. Что нужно изменить (только бэкенд)

Использовать ту же схему, что и в TapEnergyView, но от **финальной начисленной энергии за забег** (`final_energy`), а не от `tapped_kw`.

**Место:** `edit/core/views.py`, класс **GameRunClaimView**, метод **post**, сразу после начисления энергии пользователю (после обновления `UserProfile.energy` и при необходимости `WalletInfo`), но **до** очистки `energy_run_start_storage` и возврата ответа.

**Логика (псевдокод):**

1. После расчёта `final_energy` и начисления его на баланс игрока.
2. Если у `user_profile` есть `referrer`:
   - Рефереру 1-го уровня:  
     `bonus_kw_level_1 += final_energy * 0.1`  
     (то же в F-выражениях для атомарности).
   - У текущего пользователя (реферала):  
     `bring_bonus_kw_level_1 += final_energy * 0.1`
3. Если у `user_profile` есть `referrer_level_2`:
   - Рефереру 2-го уровня:  
     `bonus_kw_level_2 += final_energy * 0.05`
   - У реферера 1-го уровня (не у текущего пользователя):  
     `bring_bonus_kw_level_2 += final_energy * 0.05`

**Важно:** брать именно **final_energy** (уже с учётом проигрыша и сохранённого процента), а не `energy_collected`, чтобы реферальный бонус соответствовал тому, что реально получил игрок.

Обработку исключений можно сделать по аналогии с TapEnergyView (try/except, при ошибке не падать весь claim, а только не начислить реф-бонусы и залогировать).

---

## 5. Фронтенд и API

- **Фронтенд:** менять не требуется. Количество энергии и факт начисления уже передаются через `game-run-claim/`; начисление реферерам — внутренняя логика бэкенда.
- **Контракт API** `game-run-claim/`: запрос и ответ можно не менять; новые поля в ответе не обязательны (при желании можно добавить, например, `referral_bonus_applied: true` для аналитики).

---

## 6. Файлы для правок (когда будете вносить изменения)

| Файл | Изменение |
|------|-----------|
| `edit/core/views.py` | В **GameRunClaimView.post** после начисления `final_energy` пользователю добавить блок начисления реферальных бонусов по той же схеме, что в **TapEnergyView** (10% / 5%, обновление `bonus_kw_level_1/2` и `bring_bonus_kw_level_1/2`). |
| При необходимости | `views.py` в корне — если там есть дублирующий обработчик claim, синхронизировать логику. (В текущем проекте claim находится в `edit/core/views.py`.) |

---

## 7. Проверка и риски

- **Идемпотентность:** реф-бонусы начисляются один раз вместе с единственным успешным claim; при повторном запросе claim возвращается 200 с `already_claimed` без повторного начисления — дублирования реф-бонусов не будет.
- **Тренировочные забеги:** если тренировочный забег не вызывает `game-run-claim/` (не начисляет энергию), реф-бонусы за него не начисляются — это ожидаемо.
- **Консистентность с тапами:** коэффициенты 10% и 5% и два уровня рефералов сохраняются; отличаться будет только источник (final_energy за забег вместо tapped_kw за тап).

---

## 8. Краткое резюме

- Реферальная система по kW уже есть и работает для тапов (TapEnergyView): 10% рефереру 1, 5% рефереру 2, плюс поля `bring_bonus_*`.
- Энергия за забег начисляется только в **GameRunClaimView** при нажатии «Забрать»; там реф-логики пока нет.
- **Нужно:** в **GameRunClaimView** после начисления `final_energy` игроку добавить начисление реферальных бонусов по той же формуле (10% / 5%) и тем же полям, что в TapEnergyView. Фронт и контракт API менять не обязательно.

После внесения правок достаточно протестировать сценарий: пользователь с реферером и реферером 2-го уровня завершает забег, нажимает «Забрать» — у рефереров должны увеличиться `bonus_kw_level_1` / `bonus_kw_level_2` и соответствующие `bring_bonus_*`.
