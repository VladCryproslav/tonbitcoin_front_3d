# Анализ раннера и ошибки «Ошибка при начислении энергии»

## 1. Контекст

Пользователи иногда видят сообщение **«Ошибка при начислении энергии»**. Ошибка не у всех и не постоянная, что указывает на возможную связь с качеством интернет-соединения. В документе разобраны поток начисления энергии, точки отказа и идея проверки соединения при предзагрузке.

---

## 2. Архитектура потока раннера (начисление энергии)

### 2.1 Последовательность запросов

| Этап | Действие пользователя | API | Назначение |
|------|------------------------|-----|------------|
| 1 | Нажимает «Старт» (после загрузки моделей) | `POST energy-run-start/` | Фиксирует старт забега, сохраняет `energy_run_last_started_at`, `energy_run_start_storage`, обнуляет `storage`. Cooldown 60 мин. |
| 2 | Играет, забег завершается (win/lose) | `POST game-run-complete/` | Валидация данных забега (дистанция, энергия, поинты, время). **Энергию не начисляет** — только возвращает расчёт. |
| 3 | Нажимает «Забрать» на экране результатов | `POST game-run-claim/` | **Начисление энергии** на баланс, обновление WalletInfo, очистка `energy_run_start_storage`. |

Начисление происходит **только** в шаге 3 (`game-run-claim/`). Сообщение «Ошибка при начислении энергии» показывается при любой ошибке именно этого запроса.

### 2.2 Где показывается ошибка (фронтенд)

- **Файл:** `src/views/GameRunView.vue`
- **Функция:** `handleClaim` (примерно строки 2575–2638)

```javascript
const response = await host.post('game-run-claim/', {
  energy_collected: completedRunData.value.energy_collected,
  is_win: completedRunData.value.is_win
})
// ...
} catch (error) {
  console.error('Ошибка при начислении энергии:', error)
  alert(error.response?.data?.error || 'Ошибка при начислении энергии')
}
exitToMain()
```

Текст в `alert` берётся из `error.response?.data?.error` при ответе сервера или подставляется строка по умолчанию при сетевой ошибке (нет ответа).

### 2.3 Откуда берутся данные для «Забрать»

- `completedRunData` заполняется в `endGame()` после вызова `gameRun.completeRun(isWinByState)`.
- Если `game-run-complete/` успешен — в `completedRunData` попадают данные с сервера (`energy_collected`, `is_win`, `energy_gained`).
- Если `game-run-complete/` падает (сеть/таймаут) — `result` приходит `null`, используется локальный fallback: `savedEnergyBeforeComplete`, `savedEnergyCollectedForModal` и т.д. Модалка результатов всё равно показывается, кнопка «Забрать» доступна.

Важно: на бэкенде **`game-run-complete/` не меняет** `energy_run_start_storage` — он выставляется при `energy-run-start/`. Поэтому даже при неудачном `game-run-complete/` пользователь может нажать «Забрать», и `game-run-claim/` с точки зрения бэкенда валиден (если запрос дойдёт).

---

## 3. Причины ошибки «Ошибка при начислении энергии»

Ошибка возникает в `catch` при вызове `host.post('game-run-claim/', ...)`. Возможные причины:

### 3.1 Сетевые (наиболее вероятно при «не у всех»)

- Таймаут запроса (у axios в проекте **таймаут не задан** — см. `axios.config.js`).
- Обрыв соединения, reset, нестабильный канал.
- Очень высокая задержка: запрос висит долго, пользователь может перезагрузить страницу или соединение обрывается по таймауту на стороне прокси/оператора.

Итог: на клиенте — исключение, в `error.response` может не быть данных → показывается дефолтное «Ошибка при начислении энергии». На сервере запрос может так и не дойти, либо дойти с задержкой.

### 3.2 Ответы бэкенда 4xx

- **400 Run not started** — нет `energy_run_last_started_at`.
- **400 Run data not found** — `energy_run_start_storage is None` (уже обнулён после предыдущего успешного claim или аномалия).
- **400 Run expired** — с момента `energy_run_last_started_at` прошло > 2 часов (7200 сек).
- **400 Invalid energy_collected** — отрицательное значение.
- **400 Energy collected exceeds maximum allowed** — `energy_collected` > `energy_run_start_storage`.

В этих случаях в `error.response?.data?.error` может быть текст от сервера; он и показывается в `alert`, иначе — снова дефолтная строка.

### 3.3 Ответы бэкенда 5xx

- Любая необработанная ошибка в `GameRunClaimView` (edit/core/views.py) возвращает 500 и сообщение в `error.response?.data?.error`. Пользователь видит общую или техническую формулировку.

---

## 4. Связь с интернетом

- Ошибка **не у всех и не постоянная** хорошо согласуется с сетевыми проблемами: нестабильный Wi‑Fi, мобильный интернет, перегрузка канала, таймауты на маршруте.
- Критичный момент — один запрос `game-run-claim/`: если он не дошёл или ответ не вернулся к клиенту, пользователь видит «Ошибка при начислении энергии», при этом бэкенд мог:
  - не получить запрос (энергия не начислена);
  - получить и начислить, но ответ не дошёл до клиента (редко, но возможно — тогда при следующем заходе энергия уже будет на балансе, повторный claim получит 400 Run data not found).

---

## 5. Текущее состояние клиента (таймауты, retry)

- **axios (host):** в `axios.config.js` для `host` **не задан `timeout`** — запросы могут висеть до обрыва соединения.
- **Повтор при ошибке:** в `handleClaim` **нет retry** — одна попытка, при любой ошибке — `alert` и `exitToMain()`.
- **Предзагрузка:** перед стартом забега идёт предзагрузка моделей (`preloadAllModels` в `onSceneReady`), но проверки качества сети или пинга до API нет.

---

## 6. Идея: проверка пинга/соединения при предзагрузке

Цель: до старта забега оценить качество соединения и, если оно плохое, предупредить пользователя, чтобы он по возможности перешёл на более стабильную сеть.

### 6.1 Что можно делать

- **В момент предзагрузки** (например, после/во время загрузки моделей или перед показом кнопки «Старт») выполнить несколько лёгких запросов к бэкенду (например, HEAD или GET к быстрому эндпоинту) и замерить RTT.
- Либо использовать один быстрый эндпоинт (например, проверка авторизации или специальный `ping/`), за несколько попыток вычислить средний/максимальный пинг.
- Если пинг выше заданного порога (например, > 500–1000 ms) или доля неудачных запросов выше порога — показать модалку/сообщение: «Соединение нестабильное. Для корректного начисления энергии рекомендуем перейти на стабильный интернет (Wi‑Fi или хороший мобильный сигнал). Продолжить?» с кнопками «Продолжить» / «Отмена».

### 6.2 Важные моменты

- Не блокировать запуск игры намертво: либо предупреждение с возможностью «Всё равно играть», либо только информирование без блокировки.
- Порог по пингу и количество замеров подобрать по реальным метрикам (чтобы не пугать пользователей с нормальным мобильным интернетом).
- Учитывать, что пинг при предзагрузке не гарантирует такое же качество в момент нажатия «Забрать» через несколько минут, но снижает долю заходов с заведомо плохим каналом.

### 6.3 Где в коде это удобно встроить

- **GameRunView.vue:** после успешной предзагрузки моделей (`preloadAllModels`), когда показывается блок с кнопками («Старт», «Тренировка», «Настройки», «Назад») — перед или сразу после `showLoadingSuccess` можно запустить проверку пинга и при плохом результате показать модалку/предупреждение.
- Альтернатива: проверка в момент первого отображения экрана раннера (до кнопки «Старт»), чтобы не затягивать ожидание после нажатия «Старт».

---

## 7. Дополнительные улучшения (на будущее, без правок в этом документе)

- **Таймаут для API:** задать разумный `timeout` для `host` (axios) в `axios.config.js`, чтобы не ждать бесконечно (например, 15–30 сек для claim).
- **Retry для game-run-claim:** при сетевой ошибке или таймауте дать пользователю кнопку «Повторить» на экране результатов вместо немедленного выхода; при успехе — обновить баланс и затем выйти.
- **Явные сообщения:** различать в UI «сетевая ошибка / таймаут» и «ошибка сервера (400/500)», чтобы пользователь понимал, что можно попробовать ещё раз или сменить сеть.
- **Идемпотентность / повторный claim:** на бэкенде при повторном запросе claim после уже успешного начисления возвращать 400 с понятным текстом («Энергия уже начислена») и не обнулять данные повторно — чтобы не путать логику и поддержку.

---

## 8. Краткая схема потока (для отладки)

```
[Старт]
  → energy-run-start/  (storage, cooldown, energy_run_start_storage, energy_run_last_started_at)
  → startGame()
[Игра]
  → сбор энергии, препятствия, win/lose
[Конец забега]
  → endGame(isWin)
  → gameRun.completeRun(isWin)  →  game-run-complete/  (только валидация, без начисления)
  → completedRunData = result || fallback(local)
  → showGameOver = true, модалка с кнопкой «Забрать»
[Нажатие «Забрать»]
  → handleClaim()
  → host.post('game-run-claim/', { energy_collected, is_win })
  → при успехе: обновление app/wallet, очистка completedRunData, exitToMain()
  → при ошибке: alert('Ошибка при начислении энергии' или error.response?.data?.error), exitToMain()
```

---

## 9. Файлы для правок (когда будете делать изменения)

| Задача | Файлы |
|--------|--------|
| Текст ошибки, retry, различие сеть/сервер | `src/views/GameRunView.vue` (handleClaim, модалка результатов) |
| Проверка пинга при предзагрузке | `src/views/GameRunView.vue` (preloadAllModels / onSceneReady, новый composable или утилита) |
| Таймаут axios | `axios.config.js` (или где создаётся `host`) |
| Локализация сообщений | `src/locales/ru.json`, `en.json`, `uk.json` (например, ключи про нестабильное соединение и повтор) |
| Бэкенд claim (идемпотентность, сообщения) | `edit/core/views.py` — `GameRunClaimView` |

Документ подготовлен только как анализ; правки в коде планируются отдельно.
