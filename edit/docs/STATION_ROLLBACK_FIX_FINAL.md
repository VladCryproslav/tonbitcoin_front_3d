# –§–ò–ù–ê–õ–¨–ù–ê–Ø –ò–ù–°–¢–†–£–ö–¶–ò–Ø: –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –º–∞—Å—Å–æ–≤–æ–≥–æ –æ—Ç–∫–∞—Ç–∞ —Å—Ç–∞–Ω—Ü–∏–π

## üìä –ê–Ω–∞–ª–∏–∑ –∏–Ω—Ü–∏–¥–µ–Ω—Ç–∞

### –§–∞–∫—Ç—ã –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö

**–î–∞—Ç–∞:** 24 –¥–µ–∫–∞–±—Ä—è 2025 –≥–æ–¥–∞  
**–í—Ä–µ–º—è:** 09:17:45 - 09:18:12 UTC (27 —Å–µ–∫—É–Ω–¥)  
**–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—Ç–∫–∞—Ç–æ–≤:** 261 —Å—Ç–∞–Ω—Ü–∏—è

**–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ —Ç–∏–ø–∞–º:**
- Nuclear power plant: 183 –æ—Ç–∫–∞—Ç–∞
- Thermonuclear power plant: 64 –æ—Ç–∫–∞—Ç–∞
- Dyson Sphere: 13 –æ—Ç–∫–∞—Ç–æ–≤
- Neutron star: 1 –æ—Ç–∫–∞—Ç

**–•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏:**
- –í—Å–µ –æ—Ç–∫–∞—Ç—ã –ø—Ä–æ–∏–∑–æ—à–ª–∏ –≤ —Ç–µ—á–µ–Ω–∏–µ 27 —Å–µ–∫—É–Ω–¥
- –ü–∏–∫: 09:18 (158 –æ—Ç–∫–∞—Ç–æ–≤ –∑–∞ –º–∏–Ω—É—Ç—É)
- –ö–∞–∂–¥—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ—Ç–µ—Ä—è–ª –ø–æ 1 —Å—Ç–∞–Ω—Ü–∏–∏ (–Ω–µ—Ç –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö –æ—Ç–∫–∞—Ç–æ–≤ —É –æ–¥–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è)
- –≠—Ç–æ —É–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–∞ —Å–∏—Å—Ç–µ–º–Ω—É—é –ø—Ä–æ–±–ª–µ–º—É, –∞ –Ω–µ –Ω–∞ –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–µ —Å–ª—É—á–∞–∏

### –ö–æ—Ä–Ω–µ–≤–∞—è –ø—Ä–∏—á–∏–Ω–∞

–ú–∞—Å—Å–æ–≤—ã–π –æ—Ç–∫–∞—Ç –ø—Ä–æ–∏–∑–æ—à–µ–ª –∏–∑-–∑–∞ **–ø—Ä–æ–±–ª–µ–º —Å TON API**:
1. API –≤–µ—Ä–Ω—É–ª –æ—à–∏–±–∫—É 500 (Internal Server Error) –∏–ª–∏ –Ω–µ–ø–æ–ª–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
2. –ö–æ–¥ –Ω–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –æ—à–∏–±–∫–∏ API (–Ω–µ—Ç try/except)
3. –ü—Ä–∏ –æ—à–∏–±–∫–µ –∑–∞–ø—Ä–æ—Å—ã –ø–∞–¥–∞—é—Ç, –Ω–æ –∫–æ–¥ –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç —Ä–∞–±–æ—Ç—É
4. `all_nfts` —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è –Ω–µ–ø–æ–ª–Ω—ã–º - –Ω–µ –≤—Å–µ NFT –ø–æ–ø–∞–ª–∏ –≤ —Å–ø–∏—Å–æ–∫
5. `users` dict —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è –Ω–µ–ø–æ–ª–Ω—ã–º - —Ç–æ–ª—å–∫–æ —Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏, —á—å–∏ NFT –ø–æ–ø–∞–ª–∏ –≤ –æ—Ç–≤–µ—Ç
6. –ü—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ —Å—Ç–∞–Ω—Ü–∏–π: –¥–ª—è –≤—Å–µ—Ö —Å—Ç–∞–Ω—Ü–∏–π, —á—å–∏ NFT –Ω–µ –ø–æ–ø–∞–ª–∏ –≤ –æ—Ç–≤–µ—Ç:
   - `user = users.get(station_nft.wallet)` –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç `None`
   - `mint_string = ""` (–ø—É—Å—Ç–∞—è —Å—Ç—Ä–æ–∫–∞)
   - `station_nft.nft not in mint_string` = `True`
   - –í—ã–∑—ã–≤–∞–µ—Ç—Å—è `reset_station()` ‚Üí —Å—Ç–∞–Ω—Ü–∏—è –æ—Ç–∫–∞—á–µ–Ω–∞

## üîç –ü—Ä–æ–±–ª–µ–º–Ω—ã–π –∫–æ–¥

**–§–∞–π–ª:** `edit/t.py`  
**–§—É–Ω–∫—Ü–∏—è:** `main_mint()`  
**–°—Ç—Ä–æ–∫–∏:** 309-577

### –ü—Ä–æ–±–ª–µ–º–Ω—ã–π —É—á–∞—Å—Ç–æ–∫ 1: –ó–∞–ø—Ä–æ—Å—ã –∫ API –±–µ–∑ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫ (—Å—Ç—Ä–æ–∫–∏ 318-333)

```318:333:edit/t.py
i = 0
while True:
    # Fetch 4 pages in batch
    pages = list(range(i, i + PAGES))
    results = [async_to_sync(get_nfts)(collection_addr, page) for page in pages]

    has_short_page = False
    for data in results:
        all_nfts.extend(data.nft_items)
        logging.info(f"{len(data.nft_items)}")
        if len(data.nft_items) < 1000:
            has_short_page = True

    if has_short_page:
        break
    i += PAGES
```

**–ü—Ä–æ–±–ª–µ–º—ã:**
- –ù–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫ - –µ—Å–ª–∏ `get_nfts()` —É–ø–∞–¥–µ—Ç, –≤–µ—Å—å —Å–∫—Ä–∏–ø—Ç —É–ø–∞–¥–µ—Ç –∏–ª–∏ –≤–µ—Ä–Ω–µ—Ç –Ω–µ–ø–æ–ª–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
- –ù–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ –Ω–∞ –ø–æ–ª–Ω–æ—Ç—É –¥–∞–Ω–Ω—ã—Ö
- –ù–µ—Ç retry –º–µ—Ö–∞–Ω–∏–∑–º–∞

### –ü—Ä–æ–±–ª–µ–º–Ω—ã–π —É—á–∞—Å—Ç–æ–∫ 2: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞–Ω—Ü–∏–π –±–µ–∑ –∑–∞—â–∏—Ç—ã (—Å—Ç—Ä–æ–∫–∏ 552-577)

```552:577:edit/t.py
logging.info("")
logging.info("checking nfts")
for station_nft in StationNFTOwner.objects.filter(nft__isnull=False).exclude(
    nft=""
):
    try:
        user = users.get(station_nft.wallet or "")
        if user is None:
            mint_string = ""
        else:
            mint_string = ";".join(user["mint_string"])
        if (
            station_nft.nft not in mint_string
            or nfts_info[station_nft.nft]["nft"].sale is not None
        ):
            Notification.objects.create(
                user=station_nft.user, notif_type="nft_not_found"
            )
            station_nft.user.reset_station()
            logger.info(
                f"station_nft not in mint string {station_nft.nft} | {mint_string}"
            )
            logger.info(station_nft)

    except Exception:
        logger.exception("err profile")
```

**–ü—Ä–æ–±–ª–µ–º—ã:**
- –ù–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ–ª–Ω–æ—Ç—ã –¥–∞–Ω–Ω—ã—Ö –ø–µ—Ä–µ–¥ –ø—Ä–æ–≤–µ—Ä–∫–æ–π —Å—Ç–∞–Ω—Ü–∏–π
- –ï—Å–ª–∏ `users` dict –Ω–µ–ø–æ–ª–Ω—ã–π (–∏–∑-–∑–∞ –æ—à–∏–±–∫–∏ API), –≤—Å–µ —Å—Ç–∞–Ω—Ü–∏–∏ –æ—Ç–∫–∞—Ç—ã–≤–∞—é—Ç—Å—è
- –ù–µ—Ç –∑–∞—â–∏—Ç—ã –æ—Ç –º–∞—Å—Å–æ–≤–æ–≥–æ –æ—Ç–∫–∞—Ç–∞

## üõ†Ô∏è –†–µ—à–µ–Ω–∏–µ: –ü–æ—à–∞–≥–æ–≤–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è

### –®–∞–≥ 1: –î–æ–±–∞–≤–∏—Ç—å —Ñ—É–Ω–∫—Ü–∏—é retry –¥–ª—è –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ API

–î–æ–±–∞–≤–∏—Ç—å –ø–µ—Ä–µ–¥ —Ñ—É–Ω–∫—Ü–∏–µ–π `main_mint()` (–ø–æ—Å–ª–µ —Å—Ç—Ä–æ–∫–∏ 308):

```python
from pytonapi.exceptions import TONAPIError
from django.core.cache import cache
import asyncio

def get_nfts_with_retry(addr, page, max_retries=3, delay=1):
    """
    –ü–æ–ª—É—á–∏—Ç—å NFT —Å –ø–æ–≤—Ç–æ—Ä–Ω—ã–º–∏ –ø–æ–ø—ã—Ç–∫–∞–º–∏ –ø—Ä–∏ –æ—à–∏–±–∫–µ.
    
    Args:
        addr: –ê–¥—Ä–µ—Å –∫–æ–ª–ª–µ–∫—Ü–∏–∏
        page: –ù–æ–º–µ—Ä —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        max_retries: –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ø—ã—Ç–æ–∫
        delay: –ù–∞—á–∞–ª—å–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –º–µ–∂–¥—É –ø–æ–ø—ã—Ç–∫–∞–º–∏ (—Å–µ–∫—É–Ω–¥—ã)
    
    Returns:
        –†–µ–∑—É–ª—å—Ç–∞—Ç –∑–∞–ø—Ä–æ—Å–∞ –∏–ª–∏ None –ø—Ä–∏ –Ω–µ—É–¥–∞—á–µ
    """
    for attempt in range(max_retries):
        try:
            result = async_to_sync(get_nfts)(addr, page)
            return result
        except (TONAPIError, Exception) as e:
            if attempt == max_retries - 1:
                logger.error(
                    f"Failed to fetch NFTs page {page} after {max_retries} attempts: {e}"
                )
                return None
            wait_time = delay * (2 ** attempt)  # –≠–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞: 1s, 2s, 4s
            logger.warning(
                f"Error fetching NFTs page {page}, attempt {attempt + 1}/{max_retries}: {e}. "
                f"Retrying in {wait_time}s..."
            )
            time.sleep(wait_time)
    return None
```

### –®–∞–≥ 2: –î–æ–±–∞–≤–∏—Ç—å —Ñ—É–Ω–∫—Ü–∏—é –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ–ª–Ω–æ—Ç—ã –¥–∞–Ω–Ω—ã—Ö

–î–æ–±–∞–≤–∏—Ç—å –ø–æ—Å–ª–µ —Ñ—É–Ω–∫—Ü–∏–∏ `get_nfts_with_retry`:

```python
def is_data_complete(all_nfts, collection_addr):
    """
    –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–ª–Ω–æ—Ç—É –¥–∞–Ω–Ω—ã—Ö NFT.
    
    Args:
        all_nfts: –°–ø–∏—Å–æ–∫ –ø–æ–ª—É—á–µ–Ω–Ω—ã—Ö NFT
        collection_addr: –ê–¥—Ä–µ—Å –∫–æ–ª–ª–µ–∫—Ü–∏–∏
    
    Returns:
        True –µ—Å–ª–∏ –¥–∞–Ω–Ω—ã–µ –ø–æ–ª–Ω—ã–µ, False –µ—Å–ª–∏ –Ω–µ–ø–æ–ª–Ω—ã–µ
    """
    # –ü–æ–ª—É—á–∏—Ç—å –æ–∂–∏–¥–∞–µ–º–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏–∑ –∫—ç—à–∞
    cache_key = f"expected_nft_count_{collection_addr}"
    expected_count = cache.get(cache_key)
    
    if expected_count is None:
        # –ï—Å–ª–∏ –Ω–µ—Ç –∫—ç—à–∞, —Å—á–∏—Ç–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª–Ω—ã–º–∏ (–ø–µ—Ä–≤—ã–π –∑–∞–ø—É—Å–∫)
        logger.info(f"No cached NFT count for {collection_addr}, assuming data is complete")
        return True
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –ø–æ–ª—É—á–µ–Ω–æ –Ω–µ –º–µ–Ω–µ–µ 90% –æ–∂–∏–¥–∞–µ–º–æ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞
    threshold = expected_count * 0.9
    actual_count = len(all_nfts)
    
    if actual_count < threshold:
        logger.warning(
            f"API returned incomplete data: {actual_count}/{expected_count} "
            f"({actual_count/expected_count*100:.1f}%)"
        )
        return False
    
    logger.info(
        f"Data completeness check passed: {actual_count}/{expected_count} "
        f"({actual_count/expected_count*100:.1f}%)"
    )
    return True

def save_expected_nft_count(collection_addr, count):
    """
    –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –æ–∂–∏–¥–∞–µ–º–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ NFT –≤ –∫—ç—à.
    
    Args:
        collection_addr: –ê–¥—Ä–µ—Å –∫–æ–ª–ª–µ–∫—Ü–∏–∏
        count: –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ NFT
    """
    cache_key = f"expected_nft_count_{collection_addr}"
    cache.set(cache_key, count, timeout=86400)  # 24 —á–∞—Å–∞
    logger.info(f"Saved expected NFT count for {collection_addr}: {count}")
```

### –®–∞–≥ 3: –ò—Å–ø—Ä–∞–≤–∏—Ç—å –∑–∞–ø—Ä–æ—Å—ã –∫ API —Å –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –æ—à–∏–±–æ–∫

–ó–∞–º–µ–Ω–∏—Ç—å —Å—Ç—Ä–æ–∫–∏ 318-333 –≤ `main_mint()`:

```python
i = 0
failed_pages = []
while True:
    # Fetch pages in batch
    pages = list(range(i, i + PAGES))
    results = []
    
    for page in pages:
        result = get_nfts_with_retry(collection_addr, page)
        if result is None:
            failed_pages.append(page)
            logger.error(f"Failed to fetch page {page} after all retries")
        else:
            results.append(result)
    
    # –ï—Å–ª–∏ –≤—Å–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –Ω–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å, –ø—Ä–µ—Ä—ã–≤–∞–µ–º
    if not results:
        logger.error(f"Failed to fetch any pages starting from {i}, aborting")
        break
    
    has_short_page = False
    for data in results:
        if data is not None:
            all_nfts.extend(data.nft_items)
            logging.info(f"{len(data.nft_items)}")
            if len(data.nft_items) < 1000:
                has_short_page = True
    
    # –ï—Å–ª–∏ –±—ã–ª–∏ –æ—à–∏–±–∫–∏, –Ω–æ –ø–æ–ª—É—á–∏–ª–∏ —Ö–æ—Ç—è –±—ã —á–∞—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö, –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º
    if failed_pages:
        logger.warning(f"Some pages failed: {failed_pages}, but continuing with available data")
    
    if has_short_page:
        break
    i += PAGES
```

### –®–∞–≥ 4: –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É –ø–æ–ª–Ω–æ—Ç—ã –¥–∞–Ω–Ω—ã—Ö –ø–æ—Å–ª–µ –ø–æ–ª—É—á–µ–Ω–∏—è NFT

–î–æ–±–∞–≤–∏—Ç—å –ø–æ—Å–ª–µ —Å—Ç—Ä–æ–∫–∏ 335 (–ø–æ—Å–ª–µ `logging.info(f"FINAL {len(all_nfts)}")`):

```python
logging.info(f"FINAL {len(all_nfts)}")

# –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –æ–∂–∏–¥–∞–µ–º–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–π –ø—Ä–æ–≤–µ—Ä–∫–∏
if len(all_nfts) > 0:
    save_expected_nft_count(collection_addr, len(all_nfts))

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –ø–æ–ª–Ω–æ—Ç—É –¥–∞–Ω–Ω—ã—Ö
if not is_data_complete(all_nfts, collection_addr):
    logger.error(
        f"API returned incomplete data for collection {collection_addr}. "
        f"Received {len(all_nfts)} NFTs. Skipping station check to prevent mass rollback."
    )
    # –ü–æ–ø—ã—Ç–∫–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫—ç—à –∏–∑ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ —É—Å–ø–µ—à–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞
    cache_key = f"last_successful_nfts_{collection_addr}"
    cached_nfts = cache.get(cache_key)
    if cached_nfts:
        logger.info(f"Using cached NFT data from previous successful request")
        all_nfts = cached_nfts
        # –ü–µ—Ä–µ—Å–æ–∑–¥–∞–µ–º users dict –∏–∑ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
        users = {}
        for nft in all_nfts:
            address = nft.owner.address.root
            nft_address = nft.address.root
            users.setdefault(address, {"mint_string": []})
            users[address]["mint_string"].append(nft_address)
    else:
        logger.error("No cached data available, aborting to prevent mass rollback")
        return  # –ù–ï –ø—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞–Ω—Ü–∏–∏ –ø—Ä–∏ –Ω–µ–ø–æ–ª–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö

# –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —É—Å–ø–µ—à–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –≤ –∫—ç—à
if len(all_nfts) > 0:
    cache_key = f"last_successful_nfts_{collection_addr}"
    cache.set(cache_key, all_nfts, timeout=600)  # 10 –º–∏–Ω—É—Ç
    logger.info(f"Cached {len(all_nfts)} NFTs for fallback use")
```

### –®–∞–≥ 5: –î–æ–±–∞–≤–∏—Ç—å –∑–∞—â–∏—Ç—É –ø–µ—Ä–µ–¥ –ø—Ä–æ–≤–µ—Ä–∫–æ–π —Å—Ç–∞–Ω—Ü–∏–π

–î–æ–±–∞–≤–∏—Ç—å –ø–µ—Ä–µ–¥ —Å—Ç—Ä–æ–∫–æ–π 552 (–ø–µ—Ä–µ–¥ `logging.info("checking nfts")`):

```python
# –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –ó–ê–©–ò–¢–ê: –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–ª–Ω–æ—Ç—ã –¥–∞–Ω–Ω—ã—Ö –ø–µ—Ä–µ–¥ –ø—Ä–æ–≤–µ—Ä–∫–æ–π —Å—Ç–∞–Ω—Ü–∏–π
if not is_data_complete(all_nfts, collection_addr):
    logger.error(
        "CRITICAL: API data incomplete before station check. "
        "Skipping station check to prevent mass rollback."
    )
    # –ü–æ–ø—ã—Ç–∫–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫—ç—à
    cache_key = f"last_successful_nfts_{collection_addr}"
    cached_nfts = cache.get(cache_key)
    if cached_nfts and len(cached_nfts) > len(all_nfts) * 1.1:
        logger.warning("Using cached data as it's more complete")
        all_nfts = cached_nfts
        # –ü–µ—Ä–µ—Å–æ–∑–¥–∞–µ–º users dict
        users = {}
        nfts_info = {}
        for nft in all_nfts:
            address = nft.owner.address.root
            nft_address = nft.address.root
            users.setdefault(address, {"mint_string": []})
            users[address]["mint_string"].append(nft_address)
            nfts_info[nft_address] = {"nft": nft}
    else:
        logger.error("No valid cached data available. ABORTING station check.")
        return

logging.info("")
logging.info("checking nfts")
```

### –®–∞–≥ 6: –£–ª—É—á—à–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É –æ—à–∏–±–æ–∫ –≤ –ø—Ä–æ–≤–µ—Ä–∫–µ —Å—Ç–∞–Ω—Ü–∏–π

–ò–∑–º–µ–Ω–∏—Ç—å —Å—Ç—Ä–æ–∫–∏ 554-577 –¥–ª—è –±–æ–ª–µ–µ –±–µ–∑–æ–ø–∞—Å–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏:

```python
for station_nft in StationNFTOwner.objects.filter(nft__isnull=False).exclude(
    nft=""
):
    try:
        user = users.get(station_nft.wallet or "")
        if user is None:
            # –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –ü–†–û–í–ï–†–ö–ê: –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω, —ç—Ç–æ –º–æ–∂–µ—Ç –±—ã—Ç—å –∏–∑-–∑–∞ –æ—à–∏–±–∫–∏ API
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —ç—Ç–æ –º–∞—Å—Å–æ–≤–æ–π –ø—Ä–æ–±–ª–µ–º–æ–π
            missing_users_count = StationNFTOwner.objects.filter(
                nft__isnull=False
            ).exclude(nft="").exclude(wallet__in=users.keys()).count()
            
            if missing_users_count > 50:  # –ü–æ—Ä–æ–≥ –º–∞—Å—Å–æ–≤–æ–π –ø—Ä–æ–±–ª–µ–º—ã
                logger.error(
                    f"CRITICAL: {missing_users_count} station owners not found in users dict. "
                    f"This indicates API data incompleteness. ABORTING station check."
                )
                break  # –ü—Ä–µ—Ä—ã–≤–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É, —á—Ç–æ–±—ã –Ω–µ –æ—Ç–∫–∞—Ç–∏—Ç—å –≤—Å–µ —Å—Ç–∞–Ω—Ü–∏–∏
            
            mint_string = ""
        else:
            mint_string = ";".join(user["mint_string"])
        
        # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞: —É–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ nft_info —Å–æ–¥–µ—Ä–∂–∏—Ç —ç—Ç–æ—Ç NFT
        if station_nft.nft not in nfts_info:
            logger.warning(
                f"Station NFT {station_nft.nft} not found in nfts_info. "
                f"This may indicate incomplete API data. Skipping this station."
            )
            continue
        
        if (
            station_nft.nft not in mint_string
            or nfts_info[station_nft.nft]["nft"].sale is not None
        ):
            Notification.objects.create(
                user=station_nft.user, notif_type="nft_not_found"
            )
            station_nft.user.reset_station()
            logger.info(
                f"station_nft not in mint string {station_nft.nft} | {mint_string}"
            )
            logger.info(station_nft)

    except KeyError as e:
        logger.error(f"KeyError in station check: {e}. NFT may be missing from nfts_info.")
        continue
    except Exception:
        logger.exception("err profile")
```

### –®–∞–≥ 7: –î–æ–±–∞–≤–∏—Ç—å rate limiting –¥–ª—è –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ API

–î–æ–±–∞–≤–∏—Ç—å –∑–∞–¥–µ—Ä–∂–∫—É –º–µ–∂–¥—É –∑–∞–ø—Ä–æ—Å–∞–º–∏ (–º–∏–Ω–∏–º—É–º 10ms –º–µ–∂–¥—É –∑–∞–ø—Ä–æ—Å–∞–º–∏):

```python
# –í —Ñ—É–Ω–∫—Ü–∏–∏ get_nfts_with_retry, –ø–µ—Ä–µ–¥ –∑–∞–ø—Ä–æ—Å–æ–º:
if attempt > 0:  # –ù–µ –∑–∞–¥–µ—Ä–∂–∏–≤–∞–µ–º –ø–µ—Ä–≤—É—é –ø–æ–ø—ã—Ç–∫—É
    time.sleep(0.01)  # 10ms –∑–∞–¥–µ—Ä–∂–∫–∞ –º–µ–∂–¥—É –∑–∞–ø—Ä–æ—Å–∞–º–∏
```

–ò–ª–∏ –¥–æ–±–∞–≤–∏—Ç—å –≥–ª–æ–±–∞–ª—å–Ω—É—é –∑–∞–¥–µ—Ä–∂–∫—É –≤ —Ü–∏–∫–ª–µ –∑–∞–ø—Ä–æ—Å–æ–≤ (–≤ main_mint, —Å—Ç—Ä–æ–∫–∞ 322):

```python
for page in pages:
    result = get_nfts_with_retry(collection_addr, page)
    if result is None:
        failed_pages.append(page)
        logger.error(f"Failed to fetch page {page} after all retries")
    else:
        results.append(result)
    
    # Rate limiting: –º–∏–Ω–∏–º—É–º 10ms –º–µ–∂–¥—É –∑–∞–ø—Ä–æ—Å–∞–º–∏
    if page != pages[-1]:  # –ù–µ –∑–∞–¥–µ—Ä–∂–∏–≤–∞–µ–º –ø–æ—Å–ª–µ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –∑–∞–ø—Ä–æ—Å–∞
        time.sleep(0.01)
```

## ‚úÖ –ß–µ–∫–ª–∏—Å—Ç –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π

- [ ] –î–æ–±–∞–≤–ª–µ–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è `get_nfts_with_retry()` —Å –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –æ—à–∏–±–æ–∫
- [ ] –î–æ–±–∞–≤–ª–µ–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è `is_data_complete()` –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ–ª–Ω–æ—Ç—ã –¥–∞–Ω–Ω—ã—Ö
- [ ] –î–æ–±–∞–≤–ª–µ–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è `save_expected_nft_count()` –¥–ª—è –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è
- [ ] –ò—Å–ø—Ä–∞–≤–ª–µ–Ω —Ü–∏–∫–ª –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ API —Å –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –æ—à–∏–±–æ–∫
- [ ] –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–ª–Ω–æ—Ç—ã –¥–∞–Ω–Ω—ã—Ö –ø–æ—Å–ª–µ –ø–æ–ª—É—á–µ–Ω–∏—è NFT
- [ ] –î–æ–±–∞–≤–ª–µ–Ω–∞ –∑–∞—â–∏—Ç–∞ –ø–µ—Ä–µ–¥ –ø—Ä–æ–≤–µ—Ä–∫–æ–π —Å—Ç–∞–Ω—Ü–∏–π
- [ ] –£–ª—É—á—à–µ–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –≤ –ø—Ä–æ–≤–µ—Ä–∫–µ —Å—Ç–∞–Ω—Ü–∏–π
- [ ] –î–æ–±–∞–≤–ª–µ–Ω rate limiting –¥–ª—è –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ API
- [ ] –î–æ–±–∞–≤–ª–µ–Ω–æ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ —É—Å–ø–µ—à–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
- [ ] –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–æ –Ω–∞ dev –æ–∫—Ä—É–∂–µ–Ω–∏–∏

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –¢–µ—Å—Ç 1: –°–∏–º—É–ª—è—Ü–∏—è –æ—à–∏–±–∫–∏ API

1. –í—Ä–µ–º–µ–Ω–Ω–æ –∏–∑–º–µ–Ω–∏—Ç—å `get_nfts()` —á—Ç–æ–±—ã –≤—ã–±—Ä–∞—Å—ã–≤–∞—Ç—å –∏—Å–∫–ª—é—á–µ–Ω–∏–µ
2. –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ —Å–∫—Ä–∏–ø—Ç –Ω–µ –ø–∞–¥–∞–µ—Ç
3. –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∫—ç—à –∏–ª–∏ –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞–Ω—Ü–∏–π –ø—Ä–æ–ø—É—Å–∫–∞–µ—Ç—Å—è
4. –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ —Å—Ç–∞–Ω—Ü–∏–∏ –ù–ï –æ—Ç–∫–∞—Ç—ã–≤–∞—é—Ç—Å—è

### –¢–µ—Å—Ç 2: –°–∏–º—É–ª—è—Ü–∏—è –Ω–µ–ø–æ–ª–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö

1. –í—Ä–µ–º–µ–Ω–Ω–æ –æ–≥—Ä–∞–Ω–∏—á–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º—ã—Ö NFT
2. –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–ª–Ω–æ—Ç—ã –¥–∞–Ω–Ω—ã—Ö
3. –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞–Ω—Ü–∏–π –ø—Ä–æ–ø—É—Å–∫–∞–µ—Ç—Å—è
4. –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ —Å—Ç–∞–Ω—Ü–∏–∏ –ù–ï –æ—Ç–∫–∞—Ç—ã–≤–∞—é—Ç—Å—è

### –¢–µ—Å—Ç 3: –ü—Ä–æ–≤–µ—Ä–∫–∞ retry –º–µ—Ö–∞–Ω–∏–∑–º–∞

1. –í—Ä–µ–º–µ–Ω–Ω–æ —Å–¥–µ–ª–∞—Ç—å API –Ω–µ—Å—Ç–∞–±–∏–ª—å–Ω—ã–º (–≤–æ–∑–≤—Ä–∞—â–∞—Ç—å –æ—à–∏–±–∫—É 50% –∑–∞–ø—Ä–æ—Å–æ–≤)
2. –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ retry —Ä–∞–±–æ—Ç–∞–µ—Ç
3. –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –ø–æ—Å–ª–µ –≤—Å–µ—Ö –ø–æ–ø—ã—Ç–æ–∫ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∫—ç—à –∏–ª–∏ –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–æ–ø—É—Å–∫–∞–µ—Ç—Å—è

## üö® –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–∞–≤–∏–ª–∞

1. **–ù–ò–ö–û–ì–î–ê –Ω–µ –æ—Ç–∫–∞—Ç—ã–≤–∞—Ç—å —Å—Ç–∞–Ω—Ü–∏–∏, –µ—Å–ª–∏ –¥–∞–Ω–Ω—ã–µ API –Ω–µ–ø–æ–ª–Ω—ã–µ –∏–ª–∏ –µ—Å—Ç—å –æ—à–∏–±–∫–∏!**
2. **–í—Å–µ–≥–¥–∞ –ø—Ä–æ–≤–µ—Ä—è—Ç—å –ø–æ–ª–Ω–æ—Ç—É –¥–∞–Ω–Ω—ã—Ö –ø–µ—Ä–µ–¥ –ø—Ä–æ–≤–µ—Ä–∫–æ–π —Å—Ç–∞–Ω—Ü–∏–π**
3. **–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫—ç—à –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö API**
4. **–õ–æ–≥–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –¥–µ–π—Å—Ç–≤–∏—è**
5. **–ü—Ä–µ—Ä—ã–≤–∞—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É —Å—Ç–∞–Ω—Ü–∏–π –ø—Ä–∏ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏–∏ –º–∞—Å—Å–æ–≤–æ–π –ø—Ä–æ–±–ª–µ–º—ã**

## üìù –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

1. **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥:** –î–æ–±–∞–≤–∏—Ç—å –∞–ª–µ—Ä—Ç—ã –ø—Ä–∏ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏–∏ –Ω–µ–ø–æ–ª–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö API
2. **–ú–µ—Ç—Ä–∏–∫–∏:** –û—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —É—Å–ø–µ—à–Ω—ã—Ö/–Ω–µ—É—Å–ø–µ—à–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ API
3. **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ:** –£–ª—É—á—à–∏—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
4. **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:** –†–µ–≥—É–ª—è—Ä–Ω–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å —Å—Ü–µ–Ω–∞—Ä–∏–∏ –æ—à–∏–±–æ–∫ API

## üîó –°–≤—è–∑–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã

- **`edit/t.py`** - –æ—Å–Ω–æ–≤–Ω–æ–π —Å–∫—Ä–∏–ø—Ç —Å –ø—Ä–æ–±–ª–µ–º–Ω—ã–º –∫–æ–¥–æ–º (—Å—Ç—Ä–æ–∫–∏ 309-577)
- **`core/models.py`** - –º–æ–¥–µ–ª—å `StationRollbackLog` –∏ –º–µ—Ç–æ–¥ `reset_station()`
- **`core/views.py`** - API endpoint `RollbackStationView`
- **`logs/t.log`** - –ª–æ–≥–∏ —Å–∫—Ä–∏–ø—Ç–∞

## üìÖ –ò—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π

- **2025-12-24:** –ú–∞—Å—Å–æ–≤—ã–π –æ—Ç–∫–∞—Ç 261 —Å—Ç–∞–Ω—Ü–∏–∏ –∏–∑-–∑–∞ –æ—à–∏–±–∫–∏ TON API
- **2025-12-24:** –°–æ–∑–¥–∞–Ω–∞ —Ñ–∏–Ω–∞–ª—å–Ω–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—é

---

**–í–ê–ñ–ù–û:** –≠—Ç–æ –ø—Ä–æ–¥–∞–∫—à–Ω. –í—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –æ—Å—Ç–æ—Ä–æ–∂–Ω—ã–º–∏ –∏ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–º–∏ –Ω–∞ dev –æ–∫—Ä—É–∂–µ–Ω–∏–∏ –ø–µ—Ä–µ–¥ –¥–µ–ø–ª–æ–µ–º.

